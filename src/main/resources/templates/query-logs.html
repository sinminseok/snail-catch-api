<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Snail Catcher - 쿼리 로그 조회</title>
    <style>
        body {
            background-color: #1f1f1f;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 20px;
        }

        h1 {
            color: #3399ff;
            margin-bottom: 20px;
        }

        form label, form input, form button {
            font-size: 14px;
            vertical-align: middle;
        }

        form input {
            padding: 6px 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #2b2b2b;
            color: #eee;
            margin-right: 10px;
            width: 250px;
        }

        form button {
            background-color: #3399ff;
            border: none;
            padding: 7px 15px;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        form button:hover {
            background-color: #267acc;
        }

        #status.loading {
            color: #8bc34a;
            margin-top: 10px;
        }

        #status.error {
            color: #e57373;
            margin-top: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #2b2b2b;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.8);
        }

        th, td {
            border-bottom: 1px solid #444;
            padding: 12px 15px;
            text-align: left;
            font-size: 13px;
        }

        th {
            background-color: #333;
            color: #a3c1f7;
            font-weight: 600;
            user-select: none;
        }

        tr:hover {
            background-color: #3a3a3a;
        }

        .sql-preview {
            cursor: pointer;
            color: #66aaff;
            text-decoration: underline;
            font-family: monospace;
            font-size: 13px;
            max-width: 350px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #pagination {
            margin-top: 20px;
            user-select: none;
        }

        #pagination button {
            margin: 0 4px;
            padding: 7px 14px;
            border: 1px solid #444;
            background-color: #2b2b2b;
            color: #bbb;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #pagination button:hover:not(.disabled):not(.active) {
            background-color: #3399ff;
            color: white;
            border-color: #3399ff;
        }

        #pagination button.active {
            background-color: #3399ff;
            color: white;
            border-color: #3399ff;
            cursor: default;
        }

        #pagination button.disabled {
            color: #555;
            cursor: not-allowed;
            background-color: #1f1f1f;
            border-color: #333;
        }

        /* 삭제 버튼 스타일 */
        .delete-btn {
            background-color: #e55353;
            border: none;
            color: white;
            padding: 4px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s ease;
        }

        .delete-btn:hover {
            background-color: #b03535;
        }
    </style>
</head>
<body>

<h1>쿼리 로그 조회</h1>

<form onsubmit="setApiKey(event)">
    <label for="apiKeyInput">API Key: </label>
    <input type="text" id="apiKeyInput" required placeholder="API 키를 입력하세요" />
    <button type="submit">검색</button>
</form>

<div id="status"></div>

<table>
    <thead>
    <tr>
        <th>Method Name</th>
        <th>SQL Query &amp;&amp; Execution Plan (클릭)</th>
        <th>Duration (ms)</th>
        <th>Created At</th>
        <th>Action</th>
    </tr>
    </thead>
    <tbody id="logTableBody"></tbody>
</table>

<div id="pagination"></div>

<script>
    let apiKey = null;
    let currentPage = 0;
    let totalPages = 0;
    const pageSize = 15;

    // API 키 입력 후 쿼리 로그 요청 시작
    function setApiKey(event) {
        event.preventDefault();
        apiKey = document.getElementById("apiKeyInput").value.trim();
        currentPage = 0;
        fetchQueryLogs(currentPage);
    }

    // 쿼리 로그 목록 불러오기
    function fetchQueryLogs(page) {
        const status = document.getElementById("status");
        const tbody = document.getElementById("logTableBody");
        const paginationDiv = document.getElementById("pagination");

        status.textContent = "로딩 중...";
        status.className = "loading";
        tbody.innerHTML = "";
        paginationDiv.innerHTML = "";

        if (!apiKey) {
            status.textContent = "API 키를 입력하세요.";
            status.className = "error";
            return;
        }

        fetch(`/api/query-logs?page=${page}&size=${pageSize}`, {
            method: "GET",
            headers: { "X-API-KEY": apiKey }
        })
        .then(res => {
            if (!res.ok) throw new Error("API 호출 실패");
            return res.json();
        })
        .then(data => {
            const response = data.data;
            const logs = response?.content || response || [];
            totalPages = response?.totalPages ?? 0;
            currentPage = response?.currentPage ?? page;

            if (logs.length === 0) {
                status.textContent = "데이터가 없습니다.";
                status.className = "";
                return;
            }

            logs.forEach((log) => {
                const truncatedQuery = log.sqlQuery.length > 100
                    ? log.sqlQuery.slice(0, 100) + "..."
                    : log.sqlQuery;

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${escapeHtml(log.methodName)}</td>
                    <td>
                        <div class="sql-preview" onclick="openPopup('${escapeForJs(log.sqlQuery)}', '${escapeForJs(log.executionPlan)}')" title="클릭하면 새 창에서 전체 쿼리와 실행 계획이 표시됩니다">${escapeHtml(truncatedQuery)}</div>
                    </td>
                    <td>${log.duration}</td>
                    <td>${new Date(log.createdAt).toLocaleString()}</td>
                    <td><button class="delete-btn" onclick="deleteLog('${log.id}')">Delete</button></td>
                `;
                tbody.appendChild(row);
            });

            status.textContent = "";
            status.className = "";

            renderPagination();
        })
        .catch(err => {
            status.textContent = "에러: " + err.message;
            status.className = "error";
        });
    }

    // 새 팝업으로 쿼리와 실행계획 보여주기
    function openPopup(sqlQuery, executionPlan) {
        const popupHtml = `
            <!DOCTYPE html>
            <html lang="ko">
            <head>
                <meta charset="UTF-8" />
                <title>쿼리 상세 보기</title>
                <style>
                    body {
                        background-color: #1f1f1f;
                        color: #e0e0e0;
                        font-family: monospace, monospace;
                        padding: 20px;
                    }
                    h2 {
                        color: #3399ff;
                        margin-bottom: 10px;
                    }
                    pre {
                        background-color: #222;
                        border: 1px solid #444;
                        padding: 15px;
                        border-radius: 5px;
                        max-height: 300px;
                        overflow: auto;
                        white-space: pre-wrap;
                        word-break: break-word;
                    }
                    .section {
                        margin-bottom: 25px;
                    }
                </style>
            </head>
            <body>
                <div class="section">
                    <h2>SQL Query</h2>
                    <pre>${sqlQuery}</pre>
                </div>
                <div class="section">
                    <h2>Execution Plan</h2>
                    <pre>${executionPlan}</pre>
                </div>
            </body>
            </html>
        `;

        // 팝업 창 크기 및 옵션
        const popupWidth = 700;
        const popupHeight = 500;
        const left = (window.screen.width / 2) - (popupWidth / 2);
        const top = (window.screen.height / 2) - (popupHeight / 2);

        const popup = window.open("", "QueryDetails",
            `width=${popupWidth},height=${popupHeight},top=${top},left=${left},resizable=yes,scrollbars=yes`);

        popup.document.write(popupHtml);
        popup.document.close();
    }

    // 페이지네이션 렌더링
    function renderPagination() {
        const paginationDiv = document.getElementById("pagination");

        if (totalPages <= 1) {
            paginationDiv.innerHTML = "";
            return;
        }

        // 이전 버튼
        const prevBtn = document.createElement("button");
        prevBtn.textContent = "Prev";
        prevBtn.disabled = currentPage === 0;
        prevBtn.className = prevBtn.disabled ? "disabled" : "";
        prevBtn.onclick = () => {
            if (currentPage > 0) fetchQueryLogs(currentPage - 1);
        };
        paginationDiv.appendChild(prevBtn);

        // 페이지 번호 버튼 (최대 5개)
        const maxPageButtons = 5;
        let startPage = Math.max(0, currentPage - Math.floor(maxPageButtons / 2));
        let endPage = startPage + maxPageButtons - 1;
        if (endPage >= totalPages) {
            endPage = totalPages - 1;
            startPage = Math.max(0, endPage - maxPageButtons + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement("button");
            pageBtn.textContent = i + 1;
            pageBtn.className = (i === currentPage) ? "active" : "";
            pageBtn.onclick = () => fetchQueryLogs(i);
            paginationDiv.appendChild(pageBtn);
        }

        // 다음 버튼
        const nextBtn = document.createElement("button");
        nextBtn.textContent = "Next";
        nextBtn.disabled = currentPage === totalPages - 1;
        nextBtn.className = nextBtn.disabled ? "disabled" : "";
        nextBtn.onclick = () => {
            if (currentPage < totalPages - 1) fetchQueryLogs(currentPage + 1);
        };
        paginationDiv.appendChild(nextBtn);
    }

    // 로그 삭제 요청
    function deleteLog(logId) {
        if (!confirm("이 쿼리 로그를 삭제하시겠습니까?")) return;

        fetch(`/api/query-logs/${logId}`, {
            method: "DELETE",
            headers: { "X-API-KEY": apiKey }
        })
        .then(res => {
            if (!res.ok) throw new Error("삭제 실패");
            alert("삭제되었습니다.");
            fetchQueryLogs(currentPage);
        })
        .catch(err => alert("에러: " + err.message));
    }

    // XSS 방지용 HTML 이스케이프
    function escapeHtml(text) {
        if (!text) return "";
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // JS 문자열 내에 안전하게 삽입하기 위한 이스케이프 (단순화)
    function escapeForJs(text) {
        if (!text) return "";
        return escapeHtml(text).replace(/\n/g, "\\n").replace(/\r/g, "\\r").replace(/'/g, "\\'");
    }
</script>

</body>
</html>
